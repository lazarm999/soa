metadata:
  name: facerecognizer
  labels:
    nuclio.io/project-name: default
spec:
  description: \"Uses Microsoft's face API, configured with function environment variables. The function uses third-party Python packages, which are installed by using an inline configuration.\n\"
  handler: "face:handler"
  runtime: "python:3.7"
  env:
    - name: API_KEY
      value: 9955ccefe0284a3e818099babb58cae5
    - name: BASE_URL
      value: "https://eastus.api.cognitive.microsoft.com/face/v1.0/"
  resources:
    requests:
      cpu: 25m
      memory: 1Mi
  minReplicas: 1
  maxReplicas: 1
  triggers:
    default-http:
      class: ""
      kind: http
      name: default-http
      maxWorkers: 1
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxNyBUaGUgTnVjbGlvIEF1dGhvcnMuCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKIwojIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKIyBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAojIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgojIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKIyBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KCiMKIyBVc2VzIE1pY3Jvc29mdCdzIEZhY2UgQVBJIHRvIGV4dHJhY3QgZmFjZSBpbmZvcm1hdGlvbiBmcm9tIHRoZQojIHBpY3R1cmUgd2hvc2UgVVJMIGlzIHN1Ym1pdHRlZCBpbiB0aGUgcmVxdWVzdCBib2R5LiBUaGUgcmVzdWx0IGlzCiMgcmV0dXJuZWQgYXMgYSB0YWJsZSBvZiBmYWNlIG9iamVjdHMgc29ydGVkIGJ5IHRoZWlyIGNlbnRlcidzCiMgcG9zaXRpb24gaW4gdGhlIGdpdmVuIHBpY3R1cmUsIGxlZnQtdG8tcmlnaHQgYW5kIHRoZW4gdG9wLXRvLWJvdHRvbS4KIwojIFlvdSB3aWxsIG5lZWQgYSB2YWxpZCBrZXkgZnJvbSBNaWNyb3NvZnQ6CiMgaHR0cHM6Ly9henVyZS5taWNyb3NvZnQuY29tL2VuLWdiL3RyeS9jb2duaXRpdmUtc2VydmljZXMvP2FwaT1mYWNlLWFwaQojCiMgT25jZSBhIHZhbGlkIEZhY2UgQVBJIGtleSBoYXMgYmVlbiBhY3F1aXJlZCwgc2V0IGl0IGFuZCB0aGUgYXBwcm9wcmlhdGUKIyByZWdpb25hbCBiYXNlIFVSTCBhcyB0aGUgZW52aXJvbm1lbnQgZm9yIHRoaXMgZnVuY3Rpb24KIyAoaW4gdGhlIGNvbmZpZyBzZWN0aW9uKS4KIwoKIyBXZSBjYW4gYWxzbyBjb25maWd1cmUgdGhlIGZ1bmN0aW9uIGlubGluZSAtIHRocm91Z2ggYSBzcGVjaWFsbHkgY3JhZnRlZAojIGNvbW1lbnQgc3VjaCBhcyB0aGUgYmVsb3cuIFRoaXMgaXMgZnVuY3Rpb25hbGx5IGVxdWl2YWxlbnQgdG8gY3JlYXRpbmcKIyBhIGZ1bmN0aW9uLnlhbWwgZmlsZS4KCmltcG9ydCBvcwppbXBvcnQgY29nbml0aXZlX2ZhY2UgYXMgY2YKaW1wb3J0IHRhYnVsYXRlCmltcG9ydCBpbmZsZWN0aW9uCgoKZGVmIGhhbmRsZXIoY29udGV4dCwgZXZlbnQpOgoKICAgIGltYWdlX3VybCA9IGV2ZW50LmJvZHkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oaW1hZ2VfdXJsKQogICAga2V5ID0gb3MuZW52aXJvbi5nZXQoJ0FQSV9LRVknKQogICAgYmFzZV91cmwgPSBvcy5lbnZpcm9uLmdldCgnQkFTRV9VUkwnKQoKICAgIGlmIGtleSBpcyBOb25lOgogICAgICAgIGNvbnRleHQubG9nZ2VyLndhcm4oJ0ZhY2UgQVBJIGtleSBub3Qgc2V0LCBjYW5ub3QgY29udGludWUnKQogICAgICAgIHJldHVybiBfYnVpbGRfcmVzcG9uc2UoY29udGV4dCwgJ0Z1bmN0aW9uIG1pc2NvbmZpZ3VyZWQ6IEZhY2UgQVBJIGtleSBub3Qgc2V0JywgNTAzKQoKICAgIGlmIGJhc2VfdXJsIGlzIE5vbmU6CiAgICAgICAgY29udGV4dC5sb2dnZXIud2FybignRmFjZSBBUEkgYmFzZSBVUkwgbm90IHNldCwgY2Fubm90IGNvbnRpbnVlJykKICAgICAgICByZXR1cm4gX2J1aWxkX3Jlc3BvbnNlKGNvbnRleHQsICdGdW5jdGlvbiBtaXNjb25maWd1cmVkOiBGYWNlIEFQSSBiYXNlIFVSTCBub3Qgc2V0JywgNTAzKQoKICAgIGlmIG5vdCBpbWFnZV91cmw6CiAgICAgICAgY29udGV4dC5sb2dnZXIud2FybignTm8gVVJMIGdpdmVuIGluIHJlcXVlc3QgYm9keScpCiAgICAgICAgcmV0dXJuIF9idWlsZF9yZXNwb25zZShjb250ZXh0LCAnSW1hZ2UgVVJMIHJlcXVpcmVkJywgNDAwKQoKICAgIGNmLktleS5zZXQoa2V5KQogICAgY2YuQmFzZVVybC5zZXQoYmFzZV91cmwpCgogICAgdHJ5OgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ1JlcXVlc3RpbmcgZGV0ZWN0aW9uIGZyb20gRmFjZSBBUEk6IHswfScuZm9ybWF0KGltYWdlX3VybCkpCiAgICAgICAgZGV0ZWN0ZWRfZmFjZXMgPSBjZi5mYWNlLmRldGVjdChpbWFnZV91cmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWNlX2lkPUZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlcz0nYWdlLGdlbmRlcixnbGFzc2VzLHNtaWxlLGVtb3Rpb24nKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlcnJvcjoKICAgICAgICBjb250ZXh0LmxvZ2dlci53YXJuKCdGYWNlIEFQSSBlcnJvciBvY2N1cnJlZDogezB9Jy5mb3JtYXQoZXJyb3IpKQogICAgICAgIHJldHVybiBfYnVpbGRfcmVzcG9uc2UoY29udGV4dCwgJ0ZhY2UgQVBJIGVycm9yIG9jY3VycmVkJywgNTAzKQoKICAgIHBhcnNlZF9mYWNlcyA9IFtdCgogICAgZm9yIGZhY2UgaW4gZGV0ZWN0ZWRfZmFjZXM6CiAgICAgICAgY29vcmRpbmF0ZXMgPSBmYWNlWydmYWNlUmVjdGFuZ2xlJ10KICAgICAgICBhdHRyaWJ1dGVzID0gZmFjZVsnZmFjZUF0dHJpYnV0ZXMnXQoKICAgICAgICBjZW50ZXJfeCA9IGNvb3JkaW5hdGVzWydsZWZ0J10gKyBjb29yZGluYXRlc1snd2lkdGgnXSAvIDIKICAgICAgICBjZW50ZXJfeSA9IGNvb3JkaW5hdGVzWyd0b3AnXSArIGNvb3JkaW5hdGVzWydoZWlnaHQnXSAvIDIKCiAgICAgICAgcHJpbWFyeV9lbW90aW9uID0gc29ydGVkKGF0dHJpYnV0ZXNbJ2Vtb3Rpb24nXS5pdGVtcygpLCBrZXk9bGFtYmRhIGl0ZW06IGl0ZW1bMV0pWy0xXVswXQoKICAgICAgICBwYXJzZWRfZmFjZSA9IHsKICAgICAgICAgICAgJ3gnOiBjZW50ZXJfeCwKICAgICAgICAgICAgJ3knOiBjZW50ZXJfeSwKICAgICAgICAgICAgJ3Bvc2l0aW9uJzogJyh7MH0sezF9KScuZm9ybWF0KGludChjZW50ZXJfeCksIGludChjZW50ZXJfeSkpLAogICAgICAgICAgICAnZ2VuZGVyJzogaW5mbGVjdGlvbi5odW1hbml6ZShhdHRyaWJ1dGVzWydnZW5kZXInXSksCiAgICAgICAgICAgICdhZ2UnOiBpbnQoYXR0cmlidXRlc1snYWdlJ10pLAogICAgICAgICAgICAnZ2xhc3Nlcyc6IGluZmxlY3Rpb24uaHVtYW5pemUoaW5mbGVjdGlvbi51bmRlcnNjb3JlKGF0dHJpYnV0ZXNbJ2dsYXNzZXMnXSkpLAogICAgICAgICAgICAncHJpbWFyeV9lbW90aW9uJzogaW5mbGVjdGlvbi5odW1hbml6ZShwcmltYXJ5X2Vtb3Rpb24pLAogICAgICAgICAgICAnc21pbGUnOiAnezA6LjFmfSUnLmZvcm1hdChhdHRyaWJ1dGVzWydzbWlsZSddICogMTAwKSwKICAgICAgICB9CgogICAgICAgIHBhcnNlZF9mYWNlcy5hcHBlbmQocGFyc2VkX2ZhY2UpCgogICAgcGFyc2VkX2ZhY2VzLnNvcnQoa2V5PWxhbWJkYSBmYWNlOiAoZmFjZVsneCddLCBmYWNlWyd5J10pKQoKICAgIGZpcnN0X3JvdyA9ICgnJywpICsgdHVwbGUoZmFjZVsncG9zaXRpb24nXSBmb3IgZmFjZSBpbiBwYXJzZWRfZmFjZXMpCiAgICBtYWtlX3JvdyA9IGxhbWJkYSBuYW1lOiAoaW5mbGVjdGlvbi5odW1hbml6ZShuYW1lKSwpICsgdHVwbGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWNlW25hbWVdIGZvciBmYWNlIGluIHBhcnNlZF9mYWNlcykKCiAgICBvdGhlcl9yb3dzID0gW21ha2Vfcm93KG5hbWUpIGZvciBuYW1lIGluIFsKICAgICAgICAgICAgICAgICAgJ2dlbmRlcicsICdhZ2UnLCAncHJpbWFyeV9lbW90aW9uJywgJ3NtaWxlJ11dCgogICAgcmV0dXJuIF9idWlsZF9yZXNwb25zZShjb250ZXh0LAogICAgICAgICAgICAgICAgICAgICAgICAgICB0YWJ1bGF0ZS50YWJ1bGF0ZShbZmlyc3Rfcm93XSArIG90aGVyX3Jvd3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9J2ZpcnN0cm93JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVmbXQ9J2ZhbmN5X2dyaWQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1hbGlnbj0nY2VudGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyYWxpZ249J2NlbnRlcicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAyMDApCgoKZGVmIF9idWlsZF9yZXNwb25zZShjb250ZXh0LCBib2R5LCBzdGF0dXNfY29kZSk6CiAgICByZXR1cm4gY29udGV4dC5SZXNwb25zZShib2R5PWJvZHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPXt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudF90eXBlPSd0ZXh0L3BsYWluJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c19jb2RlPXN0YXR1c19jb2RlKQo=
    commands:
      - 'pip install cognitive_face tabulate inflection'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
    timestamp: 1653396294
  loggerSinks:
    - level: debug
  platform: {}
  securityContext: {}
  priorityClassName: igz-workload-medium
  eventTimeout: ""
  version: 1
